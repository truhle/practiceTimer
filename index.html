<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
  <meta charset="UTF-8">
  <title>Practice Timer</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="choose">
    <h1 class="heading">Timer</h1>

    <form id="settings" name="settings" onsubmit="event.preventDefault(); setTimer();">
      <label class="center"> Hours
        <input id="hours" type="number" name="hours" value="" min="0" placeholder="&#8212" max="120" maxlength="3">
      </label><br>

      <label class="center"> Minutes
        <input id="mins" type="number" name="mins" placeholder="&#8212" value="" min="0" max="120" maxlength="3">
      </label><br>

      <label class="center"> Seconds
        <input id="secs" type="number" name="secs" placeholder="&#8212" value="30" min="0" max="120" maxlength="3">
      </label><br>

<!-- sound picker on top -->

      <!-- <div id="sounds-container" class="container">
        <label class="sound-select">
          <div id="sounds-tile" class="tile">
            <svg xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%">
            <image x="10%" y="10%" width="80%" height="80%"
            xlink:href="iconmonstr-bell-6.svg" />
          </svg>
        </div>
        <select class="sounds" name="sounds">
          <option value="clear">Clear Mid Bowl</option>
          <option value="engyoji">Engyoji Temple</option>
          <option value="high">High Bowl</option>
          <option value="mid">Middle Bowl</option>
          <option value="low">Low Bowl</option>
        </select>
      </label>
    </div>

      <div class="container">
        <div class="tile radio-left selected">
          <label class="radio">
            <input id="enso-radio" type="radio" name="face" value="enso" checked="checked">
            <svg xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%">
              <image x="0" y="0" width="100%" height="100%"
                xlink:href="no_background_enso.svg" />
            </svg>
          </label>
        </div>

        <div class="tile radio-right">
          <label class="radio">
            <input id="digital-radio" type="radio" name="face" value="digital">
            <p>
              30:00
            </p>
          </label>
        </div>
      </div> -->

<!-- sound picker on bottom -->
      <div id="sounds-container" class="container">
        <label class="sound-select">
          <div id="sounds-tile" class="tile">
            <svg xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%">
            <image x="10%" y="10%" width="80%" height="80%"
            xlink:href="iconmonstr-sound-wave-1.svg" />
          </svg>
        </div>
        <select class="sounds" name="sounds">
          <option value="clear">Clear Mid Bowl</option>
          <option value="engyoji">Engyoji Temple</option>
          <option value="high">High Bowl</option>
          <option value="mid">Middle Bowl</option>
          <option value="low">Low Bowl</option>
        </select>
      </label>
    </div>

      <div class="container">
        <div class="tile radio-left selected">
          <label class="radio">
            <input id="enso-radio" type="radio" name="face" value="enso" checked="checked">
            <svg xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%">
              <image x="0" y="0" width="100%" height="100%"
                xlink:href="no_background_enso.svg" />
            </svg>
          </label>
        </div>

        <div class="tile radio-right">
          <label class="radio">
            <input id="digital-radio" type="radio" name="face" value="digital">
            <p>
              30:00
            </p>
          </label>
        </div>
      </div>

      <div class="clear">

      </div>

      <input class="button" type="submit" name="start" value="Start">
    </form>
  </div>

  <div id="enso">
    <g style="height: 100%">
      <svg xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%" viewbox="0 0 500 500">
        <defs>
          <radialGradient id="round" cx="50%" cy="300%" fx="40%" fy="80%"
          r="295%" spreadMethod="pad">
            <stop offset="0%" style="stop-color:white; stop-opacity:0" />
            <stop id="opaqueStop" offset="100%" style="stop-color:white; stop-opacity:1" />
          </radialGradient>
        </defs>

        <image x="0" y="0" width="100%" height="100%"
          xlink:href="enso.svg" />

        <rect x="257.9" y="17.88" width="80" height="80"
          style="fill:url(#round);
          stroke: none;"
          transform="rotate(-84, 297.9, 57.88)" />

        <!-- circle diameter: 1244 -->
        <circle cx="250" cy="250" r="198" style="stroke: white; fill: none;
          stroke-width: 65; stroke-opacity: 1; stroke-dasharray: 1218;
          stroke-dashoffset: 0;" transform="rotate(-78.75,250,250)" />
      </svg>
    </g>
  </div>

  <div id="digital">
    <p id="digits">

    </p>
  </div>

  <script type="text/javascript">
    var choose, enso, settings, rect, circle, stop, radioLeft, radioRight, face="enso";

    window.onload = function () {
      body = document.querySelector("body");

      choose = document.querySelector("#choose");
      settings = document.querySelector("#settings");
      radioLeft = document.querySelector(".radio-left");
      radioRight = document.querySelector(".radio-right");

      enso = document.querySelector("#enso");
      digital = document.querySelector("#digital")
      digits = document.querySelector("#digits");


      rect = document.querySelector("rect");
      circle = document.querySelector("circle");
      stop = document.getElementById("opaqueStop");

      radioLeft.onclick = function(e) {
        e.preventDefault();
        this.classList.add("selected");
        radioRight.classList.remove("selected");
        face = "enso";
        document.querySelector("#enso-radio").checked = true;
      };

      radioRight.onclick = function(e) {
        e.preventDefault();
        this.classList.add("selected");
        radioLeft.classList.remove("selected");
        face = "digital";
        document.querySelector("#digital-radio").checked = true;
      };
      // radioLeft.onclick = scopedToggleRadio(e, radioRight, "enso");
      // radioRight.onclick = scopedToggleRadio(e, radioLeft, "digital");
      //
      // function scopedToggleRadio(e, other, faceName) {
      //   return function() {
      //     e.preventDefault();
      //     this.className += " selected";
      //     other.className = other.className.replace("selected", "");
      //     face = faceName;
      //   }
      // }

      settings.addEventListener("onsubmit", setTimer);
    }


    var duration, primaryTime, tailTime, fpsInterval,
        lastTime = null, shortDur = false;

    var angleIncr, radianIncr, dashIncr;

    var paused = false, wasPaused = false, pauseStartTime;

    var angle = -84, radians = (angle + 8) * (Math.PI / 180),
        angleSweep = 343.5, sweepRadians = angleSweep * (Math.PI / 180),
        dashOffset = 0, dashSweep = 1187,
        radius = 198;

    var sound;

    function setTimer() {
      // e.preventDefault();
      setSound();

      hours = Number(document.settings.hours.value);
      mins = Number(document.settings.mins.value);
      secs = Number(document.settings.secs.value);

      duration = ((hours * 3600) + (mins * 60) + secs) * 1000;

      choose.style.display = "none";

      if (face == "enso") {
        primaryTime = duration * 0.954;
        tailTime = duration - primaryTime;
        angleIncr = angleSweep / primaryTime,
        radianIncr = sweepRadians / primaryTime,
        dashIncr = dashSweep / primaryTime;

        setFPS(duration);

        body.style.background = "white";
        enso.style.display = "block";
      }
      else if (face == "digital") {
        body.style.background = "black";
        digital.style.display = "block";
      }

      scrollTo(0, 0);

      window.addEventListener("keydown", function(event) {
        var code = event.keyCode;
        if (code == "80" || code == "27") {
          if (!paused) {
            paused = true;
          }
          else {
            paused = false;
            startTimer();
          }
        }
      });

      startTimer(face);
    }

    function animateDigital(time) {
      if (paused) {
        catchPauseInterval(time);
        return;
      }
      else if (lastTime != null) {
        if (wasPaused)
          resumeFromPause(time);
        elapsed = time - lastTime;
        duration -= elapsed;
      }
      lastTime = time;

      if (duration <= 0) {
        makeSound();
        return;
      }

      var secs = Math.floor(duration / 1000) % 60,
          mins = Math.floor(secs / 60) % 60,
          hours = Math.floor(hours = mins / 60),
          minsSecs = leftPad(mins) + ":" + leftPad(secs);

      digits.innerHTML = hours > 0 ? leftPad(hours) + ":" + minsSecs :
        minsSecs;
    }

    function animateEnso(time) {
      if (paused) {
        catchPauseInterval(time);
        return;
      }
      else if (lastTime != null) {
        if (wasPaused)
          resumeFromPause(time);
        elapsed = time - lastTime;
        angle -= angleIncr * elapsed;
        radians -= radianIncr * elapsed;
        dashOffset += dashIncr * elapsed;
        duration -= elapsed;
      }
      lastTime = time;

      if (duration <= 0) {
        makeSound();
        return;
      }
      else if (duration >= tailTime) {
        var x = 210 + Math.cos(radians) * radius,
        y = 210 + Math.sin(radians) * radius,
        transfX = x + 40,
        transfY = y + 40,
        transform = "rotate(" + angle + "," + transfX + "," + transfY + ")";
        rect.setAttribute("x", x);
        rect.setAttribute("y", y);
        rect.setAttribute("transform", transform);
        circle.style['stroke-dashoffset'] = dashOffset;
      }
      else if (duration < tailTime) {
        var opacity = duration / tailTime;
        stop.style["stop-opacity"] = opacity;
      }
      if (shortDur == true)
        requestAnimationFrame(animateEnso)
    }

    function catchPauseInterval(time) {
      pauseStartTime = time;
      wasPaused = true;
    }

    function leftPad(n) {
      return n < 10 ? "0" + n : "" + n;
    }

    function makeSound() {
      sound.play();
    }

    function resumeFromPause(time) {
      var pauseInterval = time - pauseStartTime;
      lastTime += pauseInterval;
      wasPaused = false;
    }

    function runDigital() {
      setInterval(function() {
        if (duration >= 0 && paused == false)
          requestAnimationFrame(animateDigital)
      }, 100);
    }

    function runFPS(fpsInterval) {
      setInterval(function() {
        if (duration >= 0 && paused == false)
          requestAnimationFrame(animateEnso)
      }, fpsInterval);
    }

    function setFPS(duration) {
      var secs = duration / 1000, mins = secs / 60, fps;
      if (secs < 120) {
        shortDur = true;
        return;
      }
      else {
        shortDur = false;
        if (mins <= 5)
          fps = Math.ceil(45 - ((mins - 2) * 5) );
        else if (mins <= 10)
          fps = Math.ceil(30 - ((mins - 5) * 2) );
        else if (mins > 10 && mins <= 15)
          fps = 20;
        else if (mins < 20)
          fps = Math.ceil(20 - ((mins - 15) * 2));
        else if (mins < 30)
          fps = mins < 25 ? 6 : 4;
        else
          fps = 2;
      }
      fpsInterval = Math.ceil(1000 / fps);
    }

    function setSound() {
      var soundKey = document.settings.sounds.value;
      var sounds = {
        "clear": "clear-bell-bowl.wav",
        "engyoji": "engyoji-bell.mp3",
        "high": "high-bell.wav",
        "low": "low-bell-bowl.wav",
        "mid": "med-singing-bowl.wav"
      }
      sound = new Audio(sounds[soundKey]);
    }

    function startTimer(face) {
      if (face == "enso") {
        if (shortDur == false)
        runFPS(fpsInterval);
        else
        requestAnimationFrame(animateEnso);
      }
      else if (face == "digital") {
        runDigital();
      }
    }
  </script>
</body>
</html>
