<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
  <meta charset="UTF-8">
  <title>Practice Timer</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body style="background: white; height: 100%">
  <div id="choose">
    <h1 class="title">Choose</h1>

    <form id="settings" name="settings" onsubmit="event.preventDefault(); setTimer();">
      <label> Hours
        <input id="hours" type="number" name="hours" value="" min="0" placeholder="&#8212" max="120" maxlength="3">
      </label><br>

      <label> Minutes
        <input id="mins" type="number" name="mins" placeholder="&#8212" value="" min="0" max="120" maxlength="3">
      </label><br>

      <label> Seconds
        <input id="secs" type="number" name="secs" placeholder="&#8212" value="20" min="0" max="120" maxlength="3">
      </label><br>

      <input class="button" type="submit" name="start" value="Start">
    </form>
  </div>
  <div id="enso" style="height: 100%; display: none;" >
    <g style="height: 100%">
      <svg xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%" viewbox="0 0 500 500">
        <defs>
          <radialGradient id="round" cx="50%" cy="300%" fx="40%" fy="80%"
          r="295%" spreadMethod="pad">
            <stop offset="0%" style="stop-color:white; stop-opacity:0" />
            <stop id="opaqueStop" offset="100%" style="stop-color:white; stop-opacity:1" />
          </radialGradient>
        </defs>

        <image x="0" y="0" width="100%" height="100%"
          xlink:href="enso.svg" />

        <rect x="257.9" y="17.88" width="80" height="80"
          style="fill:url(#round);
          stroke: none;"
          transform="rotate(-84, 297.9, 57.88)" />

        <!-- circle diameter: 1244 -->
        <circle cx="250" cy="250" r="198" style="stroke: white; fill: none;
          stroke-width: 65; stroke-opacity: 1; stroke-dasharray: 1218;
          stroke-dashoffset: 0;" transform="rotate(-78.75,250,250)" />

      </svg>
    </g>
  </div>

  <script type="text/javascript">
    var choose, ense, settings, rect, circle, stop;

    window.onload = function () {
      choose = document.querySelector("#choose");
      enso = document.querySelector("#enso");
      settings = document.getElementById("settings");

      rect = document.querySelector("rect");
      circle = document.querySelector("circle");
      stop = document.getElementById("opaqueStop");

      settings.addEventListener("onsubmit", setTimer);
    }


    var duration, primaryTime, tailTime, fps, fpsInterval,
        lastTime = null, shortDur = false;

    var angleIncr, radianIncr, dashIncr;

    var paused = false, wasPaused = false, pauseStartTime;

    var angle = -84, radians = (angle + 8) * (Math.PI / 180),
        angleSweep = 343.5, sweepRadians = angleSweep * (Math.PI / 180),
        dashOffset = 0, dashSweep = 1187,
        radius = 198;

    function setTimer() {
      // e.preventDefault();

      hours = Number(document.settings.hours.value);
      mins = Number(document.settings.mins.value);
      secs = Number(document.settings.secs.value);

      duration = ((hours * 3600) + (mins * 60) + secs) * 1000;
      primaryTime = duration * 0.954;
      tailTime = duration - primaryTime;
      angleIncr = angleSweep / primaryTime,
      radianIncr = sweepRadians / primaryTime,
      dashIncr = dashSweep / primaryTime;

      setFPS(duration);

      choose.style.display = "none";
      enso.style.display = "block";

      window.addEventListener("keydown", function(event) {
        var code = event.keyCode;
        if (code == "80" || code == "27") {
          if (!paused) {
            paused = true;
          }
          else {
            paused = false;
            startTimer();
          }
        }
      });

      startTimer();
    }

    function animate(time) {
      if (duration <= 0) {
        return;
      }
      else if (paused) {
        catchPauseInterval(time);
        return;
      }
      else if (lastTime != null) {
        if (wasPaused)
          resumeFromPause(time);
        elapsed = time - lastTime;
        angle -= angleIncr * elapsed;
        radians -= radianIncr * elapsed;
        dashOffset += dashIncr * elapsed;
        duration -= elapsed;
      }
      lastTime = time;

      if (duration >= tailTime) {
        var x = 210 + Math.cos(radians) * radius,
        y = 210 + Math.sin(radians) * radius,
        transfX = x + 40,
        transfY = y + 40,
        transform = "rotate(" + angle + "," + transfX + "," + transfY + ")";
        rect.setAttribute("x", x);
        rect.setAttribute("y", y);
        rect.setAttribute("transform", transform);
        circle.style['stroke-dashoffset'] = dashOffset;
      }
      else if (duration < tailTime) {
        var opacity = duration / tailTime;
        stop.style["stop-opacity"] = opacity;
      }
      if (shortDur == true)
        requestAnimationFrame(animate)
    }

    function catchPauseInterval(time) {
      pauseStartTime = time;
      wasPaused = true;
    }

    function resumeFromPause(time) {
      var pauseInterval = time - pauseStartTime;
      lastTime += pauseInterval;
      wasPaused = false;
    }

    function runFPS(fpsInterval) {
      setInterval(function() {
        if (duration > 0 && paused == false)
          requestAnimationFrame(animate)
      }, fpsInterval);
    }

    function setFPS(duration) {
      var secs = duration / 1000, mins = secs / 60, fps = 45;
      if (secs < 120)
        shortDur = true;
      else {
        shortDur = false;
        if (mins <= 5)
          fps = Math.ceil(45 - ((mins - 2) * 5) );
        else if (mins <= 10)
          fps = Math.ceil(30 - ((mins - 5) * 2) );
        else if (mins > 10 && mins <= 15)
          fps = 20;
        else if (mins < 20)
          fps = Math.ceil(20 - ((mins - 15) * 2));
        else if (mins < 30)
          fps = mins < 25 ? 6 : 4;
        else
          fps = 2;
      }
      fpsInterval = Math.ceil(1000 / fps);
    }

    function startTimer() {
      if (shortDur == false)
        runFPS(fpsInterval);
      else
        requestAnimationFrame(animate);
    }
  </script>
</body>
</html>
